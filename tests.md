# Анализ разметки фотографий

## Оглавление
1. [Цель программы](#paragraph1)
2. [Допущения в программе](#paragraph2)
3. [Описание модулей](#paragraph3)
    1. [gdrive](#subparagraph31)
    2. [gsheets](#subparagraph32)
    3. [image_storage](#subparagraph33)
    4. [main](#subparagraph34)
4.  [Подготовка данных](#paragraph4)
    1. [Формат файла](#subparagraph41)
    2. [Где барть данные](#subparagraph42)
5. [Как загрузить фотографии](#paragraph5)
    1. [Получение токенов](#subparagraph51)
    2. [Создание файлов с токенами](#subparagraph52)
    3. [Запуск программы](#subparagraph53)
    4. [Предоставление доступов](#subparagraph54)
6. [Обработка ошибок](#paragraph6)

## Цель программы <a name='paragraph1'></a>
Программа написана для сбора оригиналов фотографий, которые не прошли разметку и передачи их партнеру.
Весь процесс выглядит следующим образом:
1. Собираем данные из Vertica с id фотографий
1. Получаем оригинальные ID фотографий, который хранятся в БД
1. Получам ссылки на скачивание фотографий
1. Создаем папку на GoogleDrive с названием = id items
1. Загружаем фотографии в созданную папку
1. Добавляем информацию на GoogleSheets в новую строку
1. Партнер берет данные в работу и выгружает на этот же лист результаты

Программа имеет строку загрузки, которая позволяет понимать, как идет процесс загрузки
Итог - собранные данные и разметка по причинам, по которым не сработала машинка по распознованию гос.номера авто

## Допущения в программе <a name="paragraph2"></a>
Данные скрипт не идеален и имеет свои особенности. Важно, что он позволяет решить задачу.
1. Необходимо 2 авторизационных токена: 
    * Для GoogleDrive
    * Для GoogleSheets
    
1. Файл с сырыми данными должен иметь определенное название и иметь определенное строение.
1. Лист в GSheets и основную папку для загрузки необходимо создавать руками
1. (Временно) нет автообновления токена для Gdrive
1. (Временно) нет проверки на успешность загрузки фотографий -> происходит параллельная загрузка в несколько папок Gdrive => не все фотографии могут быть загружены

## Описание модулей <a name="paragraph3"></a>
Вся программа разбита на 3 основных модуля и 1 модуль для запуска процесса. О каждом из них чуть подробнее ниже.
### gdrive <a name="subparagraph31"></a>
Данный модуль отвечает за API Google Drive. 
Основные задачи данного модуля:
1. Создать папку - необходимо для создание папки с нужным именем = items_id
2. Загрузить файлы на диск - необходим для загрузки самих файлов. Файлы загружаются по очереди, что приводит к долгой обработке

Авторизационный токен для этого модуля имеет строковое значение, получаенное на сайте https://developers.google.com/oauthplayground/. 
Модуль требует только 1 исправления. Об этом будет ниже

### gsheets <a name="subparagraph32"></a>
Модуль отвечает за загрузку информации на лист для последующей передаче партнеру
Состоит из 1 модуля - непосредственное записи подготовленных данных на 2 строку (при этом остальные строки смещаются на 1 вниз)
Для авторизации в API этого модуля необходимо получить json-файл с кредами. Об этом ниже.

### Image_storage <a name="subparagraph33"></a>
Основной модуль для работы с оригиналами фотографий.
Это единственный модуль, для работы с которым нужен только Ubikey.
Модуль разбит на несколько частей:
1. GetInfo - метод отвечает за получение Id оригинальных фотографий по Id маскированных фото
1. GetUrls - по Id оригинальной фотографии получаем список ссылок на скачивание этих фотографий в разных размерах
1. GetMaxSizePhoto - получение максимального размера фотографии

На выходе из модуля получаем список ссылок с самым большим размером фото
   
### Main <a name="subparagraph34"></a>
Блок программы, объединяющий в себе вызовы и логику формирования гугл-дока, загрузки фотографий и получения их из Image-storage

## Подготовка данных <a name="paragraph4"></a>
### Формат файла <a name="subparagraph41"></a>
Для того, чтобы программа отрабатывала корректно, необходимо подготовить файл с данными в формате:
* item_id
* external_item_id
* is_item_start
* user_id
* region_item
* user_segment
* gos.nomer filled by user
* RegistrationCarInRussia
* images_id
* external_images_id

Колонки должны быть именно в таком порядке. В последних 2 колонках id-ники должны быть перечислены через ','

### Где брать данные <a name="subparagraph42"></a>
Данные по фотографиям с маскированием есть в вертике. Если нужно сделать анализ, можно обратиться к dyuraspopova

## С чего начать (как загрузить фотографии) <a name="paragraph5"></a>
### Получение токенов <a name="subparagraph51"></a>
Для того, чтобы программа отработал корректно, необходимо получить токены авторизации.

#### GDrive-токен
Полная инструкция описана [Здесь](https://codingshiksha.com/python/how-to-upload-files-to-google-drive-using-python-3-using-google-drive-api-v3-full-project/)

Кратко:
1. Заходим на [GoogleApiPlayground](https://developers.google.com/oauthplayground/)
1. Ищем Drive API V3
1. Выбираем первую ссылки вида ../auth/drive
1. Нажимаем Authorize APIs
1. Выбираем нужный аккаунт и даем разрешение к папке
1. Нажимаем Exchange authorization code for tokens
1. Копируем токен из поля "access token"
1. Сохраняем этот токен

#### Gsheets-токен
Для получения этого токена лучше посмотреть [видео](https://www.youtube.com/watch?v=cnPlKLEGR7E&t=625s)

Делайте все, что описано в видео для получения json-файла. Json фалй необходимо сохранить в корневой папке "Image_storage" с названием creds.json

### Создаем файл с токеном <a name="subparagraph52"></a>
Для Gsheets нет необходимости что-то создавать дополнительно, т.к. вся информация будет браться из файла creds.json

Для Gdrive необходимо создать файл tokens.ini. 

Внутри файла необходим прописать структуру: 
```python
[app_name] #Т.к. у нас реализация с сетью VK, то app_name = VK
token = 'token'# Пропишите токен приложения с доступом к скачиванию фото
folder_id = 'folder_id'
```

В нашем случае: 
1. app_name = 'GDrive'
1. token = 'токен, которые мы получили в разделе GDrive-токен'
1. folder_id - это папка, внутри которой будет происходить загрузка (чтобы не создавалась в корень). id папки можно вытащить из url. 
Например, https://drive.google.com/drive/u/0/folders/1kvhA-0aQS8vTQkSbs0bUHWZf60Q9WC8U. У этого урла id папки - это последняя часть ссылки (вся).

### Запуск программы <a name="subparagraph53"></a>
Когда все необходимые приготовления сделаны - можно запускать программу через. 
1. Откройте терминал
1. Пропишите текст
```python
python main.py
```

В терминале появится бар загрузки, а также будут появлятся id айтемов, у которых не получилось найти оригинальные фотографии

### Предоставление доступов <a name="subparagraph54"></a>
После обработки программы необходимо дать доступ к файлу партнеру.
1. Gsheets открываем только партнеру
1. GDrive - необходимо для каждой папки настроить доступ для всех, у кого есть ссылка. (В интерфейсе гугл-драйв можно выбрать сразу все папки и применить к ним правило доступа)

## Обработка ошибок <a name="paragraph6"></a>
У любой программы могут случаться ошибки. На текущий момент есть обработчик на ошибки, возникающие при поиске оригиналов фотографий. Если не смогли найти - получим в консоль item_id. 
Другие ошибки также могут возникать. 
Если ошибки при запуске программы - попробуйте понять, в чем ошибка.
Если ошибки уже во время работы программы - запустите файл не с 1 айтема, а с того, на котором подвисли + 1

